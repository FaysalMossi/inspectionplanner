<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Inspection planner</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
<meta name="theme-color" content="#2f6bff">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>

   .icon{
  width: 16px;
  height: 16px;
  display:inline-block;
  vertical-align: -3px;
}
.icon.lg{ width:18px; height:18px; }
.btn .icon{ opacity: .95; }
.chip .icon{ opacity: .9; }
 

    .footer{
  margin-top: 18px;
  padding: 14px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: rgba(255,255,255,.03);
  box-shadow: var(--shadow);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}

.footer .left{
  display:flex;
  gap:10px;
  align-items:center;
  color: var(--muted);
  font-size: 12px;
}

.footer .right{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  font-size: 12px;
}

.footer a{
  color: var(--text);
  text-decoration: none;
  border-bottom: 1px dashed rgba(91,140,255,.55);
}
.footer a:hover{
  border-bottom-style: solid;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius: 999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.04);
  color: var(--muted);
}

    :root{
      --bg:#0b1020;
      --card:#111833;
      --muted:#93a4c7;
      --text:#eaf0ff;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent:#5b8cff;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --radius:16px;
    }

    /* Light mode auto */
    @media (prefers-color-scheme: light) {
      :root{
        --bg:#f6f8ff;
        --card:#ffffff;
        --muted:#5a6b8a;
        --text:#0b1020;
        --border:rgba(11,16,32,.10);
        --shadow: 0 10px 30px rgba(15,23,42,.10);
        --accent:#2f6bff;
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(91,140,255,.25), transparent 60%),
                  radial-gradient(1000px 700px at 100% 0%, rgba(34,197,94,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
    }

    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 18px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 13px;
    }

    .badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    @media (min-width: 980px){
      .grid{
        grid-template-columns: 440px 1fr;
        align-items:start;
      }
    }

    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    @media (prefers-color-scheme: light){
      .card{ background: var(--card); }
    }

    .card-h{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card-h h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .card-b{
      padding: 16px;
    }

    .field{ margin-bottom: 12px; }
    label{
      display:block;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 6px;
      color: rgba(255,255,255,.92);
    }
    @media (prefers-color-scheme: light){
      label{ color:#0b1020; }
    }

    input[type="text"], textarea{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-family: var(--mono);
      font-size: 13px;
      outline: none;
      transition: border-color .15s ease, transform .05s ease;
    }
    @media (prefers-color-scheme: light){
      input[type="text"], textarea{ background:#f7f9ff; color:#0b1020; }
    }
    input[type="text"]:focus, textarea:focus{
      border-color: rgba(91,140,255,.7);
      box-shadow: 0 0 0 4px rgba(91,140,255,.18);
    }

    .hint{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .hint code{
      font-family: var(--mono);
      font-size: 12px;
      padding: 1px 6px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
      color: var(--text);
      background: rgba(255,255,255,.05);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: linear-gradient(135deg, rgba(91,140,255,.95), rgba(91,140,255,.65));
      border-color: rgba(91,140,255,.55);
    }
    .btn.primary:hover{ background: linear-gradient(135deg, rgba(91,140,255,1), rgba(91,140,255,.72)); }

    .btn.success{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.60));
      border-color: rgba(34,197,94,.55);
    }

    .btn.ghost{
      background: transparent;
    }

    .error{
      margin: 0 0 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.12);
      color: rgba(255,255,255,.95);
      font-size: 13px;
      line-height: 1.35;
    }
    @media (prefers-color-scheme: light){
      .error{ color:#7f1d1d; background: rgba(239,68,68,.12); }
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }
    .chip b{ color: var(--text); }

    #map{
      width:100%;
      height: 420px;
      border-top: 1px solid var(--border);
    }
    @media (min-width: 980px){
      #map{ height: 520px; }
    }

    .legend{
      position: relative;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
      align-items:center;
      justify-content:space-between;
    }
    .legend .left{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .dot{
      width:10px; height:10px; border-radius:999px; display:inline-block;
      border:2px solid rgba(255,255,255,.85);
    }
    .dot.g{ background: var(--accent2); }
    .dot.b{ background: var(--accent); }
    .dot.r{ background: var(--danger); }

    .table-wrap{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12.5px;
      background: rgba(255,255,255,.02);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      text-align:right;
      white-space:nowrap;
    }
    th{
      position: sticky;
      top:0;
      z-index: 2;
      background: rgba(17,24,51,.96);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      letter-spacing:.2px;
    }
    @media (prefers-color-scheme: light){
      th{ background: #f3f6ff; color:#0b1020; }
    }
    td.name, th.name{ text-align:left; }
    .scroll{
      max-height: 340px;
      overflow:auto;
    }

    /* Loader overlay */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(4px);
      z-index: 9999;
    }
    .overlay.on{ display:flex; }
    .spinner{
      width: 48px;
      height: 48px;
      border-radius: 999px;
      border: 4px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    /* Leaflet marker numbers */
    .numbered-marker{ background: transparent; border: none; }

    .drone-badge{
  width:44px;height:44px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  border:1px solid var(--border);
  background: radial-gradient(80% 80% at 30% 20%, rgba(91,140,255,.35), rgba(17,24,51,.65));
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
  color: rgba(255,255,255,.92);
}

.mission-tag{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px;
  border:1px solid var(--border);
  background: rgba(255,255,255,.04);
  font-size:12px; color: var(--muted);
}

/* “HUD” effect autour de la carte */
.map-frame{
  position:relative;
}
.map-frame:before{
  content:"";
  position:absolute;
  inset:10px;
  pointer-events:none;
  border-radius: 14px;
  border:1px dashed rgba(91,140,255,.35);
  box-shadow: 0 0 0 1px rgba(34,197,94,.12) inset;
  z-index: 500;
}
.map-frame:after{
  content:"LIVE";
  position:absolute;
  top:12px; left:16px;
  font-size:11px;
  letter-spacing:.18em;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(34,197,94,.35);
  background: rgba(34,197,94,.12);
  color: rgba(234,240,255,.92);
  z-index: 600;
}

.notice{
  margin: 10px 16px 0;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
  color: rgba(234,240,255,.92);
  display:flex;
  gap:10px;
  align-items:flex-start;
}
.notice .title{
  font-weight: 800;
  font-size: 13px;
  margin: 0;
}
.notice .text{
  margin: 2px 0 0;
  color: var(--muted);
  font-size: 12px;
  line-height: 1.35;
}
.notice.info{
  border-color: rgba(91,140,255,.35);
  background: rgba(91,140,255,.10);
}
.notice.warn{
  border-color: rgba(245,158,11,.35);
  background: rgba(245,158,11,.10);
}

details.notice-details{
  margin: 8px 16px 0;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.03);
  border-radius: 14px;
  overflow:hidden;
}
details.notice-details > summary{
  cursor:pointer;
  list-style:none;
  padding: 10px 12px;
  font-weight: 800;
  font-size: 13px;
  color: rgba(234,240,255,.92);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
details.notice-details > summary::-webkit-details-marker{ display:none; }
details.notice-details .content{
  padding: 10px 12px 12px;
  border-top: 1px solid var(--border);
  color: var(--muted);
  font-size: 12px;
}
.dupe-list{
  margin: 0;
  padding-left: 18px;
}
.dupe-list li{
  margin: 6px 0;
}
.badge-mini{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,.04);
  color: rgba(234,240,255,.9);
  font-size: 12px;
}


  </style>
</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="i-drone" viewBox="0 0 24 24">
    <path d="M6 8h12" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M9 8v2.5a3 3 0 0 0 6 0V8" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M10.5 14h3" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M12 14v4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <circle cx="5.2" cy="8.6" r="2.2" fill="none" stroke="currentColor" stroke-width="1.4"/>
    <circle cx="18.8" cy="8.6" r="2.2" fill="none" stroke="currentColor" stroke-width="1.4"/>
  </symbol>

  <symbol id="i-reset" viewBox="0 0 24 24">
  <path d="M20 12a8 8 0 1 1-2.34-5.66" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
  <path d="M20 4v6h-6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
</symbol>


  <symbol id="i-route" viewBox="0 0 24 24">
    <path d="M6 18c0-2 2-2 2-4s-2-2-2-4 2-2 2-4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M18 6c0 2-2 2-2 4s2 2 2 4-2 2-2 4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <circle cx="6" cy="6" r="1.8" fill="none" stroke="currentColor" stroke-width="1.6"/>
    <circle cx="18" cy="18" r="1.8" fill="none" stroke="currentColor" stroke-width="1.6"/>
  </symbol>

  <symbol id="i-download" viewBox="0 0 24 24">
    <path d="M12 3v10" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M8 11l4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M5 20h14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
  </symbol>

  <symbol id="i-trash" viewBox="0 0 24 24">
    <path d="M6 7h12" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M9 7V5h6v2" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    <path d="M8 7l1 14h6l1-14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
  </symbol>

  <symbol id="i-spark" viewBox="0 0 24 24">
    <path d="M12 2l1.5 6L20 12l-6.5 4L12 22l-1.5-6L4 12l6.5-4L12 2Z"
          fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
  </symbol>

  <symbol id="i-pin" viewBox="0 0 24 24">
    <path d="M12 21s6-5 6-10a6 6 0 1 0-12 0c0 5 6 10 6 10Z" fill="none" stroke="currentColor" stroke-width="1.8"/>
    <circle cx="12" cy="11" r="2" fill="none" stroke="currentColor" stroke-width="1.8"/>
  </symbol>

  <symbol id="i-status" viewBox="0 0 24 24">
    <path d="M7 12l3 3 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </symbol>
  <symbol id="i-pin" viewBox="0 0 24 24">
  <path d="M12 21s6-5 6-10a6 6 0 1 0-12 0c0 5 6 10 6 10Z" fill="none" stroke="currentColor" stroke-width="1.8"/>
  <circle cx="12" cy="11" r="2" fill="none" stroke="currentColor" stroke-width="1.8"/>
</symbol>

<symbol id="i-ruler" viewBox="0 0 24 24">
  <path d="M4 16l10-10 6 6-10 10H4v-6Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
  <path d="M14 6l4 4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
  <path d="M9 11l1 1M11 9l1 1M7 13l1 1" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
</symbol>

</svg>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="spinner" aria-label="Chargement"></div>
  </div>

  <div class="container">
    <div class="header">
      

      <div class="brand">
  <div style="display:flex; align-items:center; gap:10px;">
    <div class="drone-badge" aria-hidden="true">
      <!-- drone icon (inline SVG) -->
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
        <path d="M6 8h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M9 8v2.5a3 3 0 0 0 6 0V8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M10.5 14h3" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M12 14v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
        <path d="M5.2 6.4c-1.2 0-2.2 1-2.2 2.2S4 10.8 5.2 10.8s2.2-1 2.2-2.2S6.4 6.4 5.2 6.4Z" stroke="currentColor" stroke-width="1.4"/>
        <path d="M18.8 6.4c-1.2 0-2.2 1-2.2 2.2s1 2.2 2.2 2.2 2.2-1 2.2-2.2-1-2.2-2.2-2.2Z" stroke="currentColor" stroke-width="1.4"/>
      </svg>
    </div>

    <div>
      <h1 style="margin:0;">Inspection planner</h1>
      <div style="margin-top:4px; color:var(--muted); font-size:12px;">
        Planification • Itinéraire TSP • Export KML
      </div>
    </div>
  </div>

  <p style="margin-top:10px;">
    Colle des coordonnées (décimal/DMS) → itinéraire optimisé + carte interactive + export KML.
  </p>
</div>



      <div class="badge">PS06</div>
    </div>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="card">
        <div class="card-h">
          <h2>Entrée des coordonnées</h2>
          <button class="btn ghost" type="button" onclick="fillExample()">Exemple</button>
        </div>
        <div class="card-b">
          {% if error %}
            <div class="error">{{ error }}</div>
          {% endif %}

          <form method="post" id="calcForm">
            <div class="field">
              <label for="start_point">Point de départ (lat, lon)</label>
              <input type="text" id="start_point" name="start_point"
                     value="{{ start_point or '' }}"
                     placeholder="12.3811833 3.424975  |  12°22'52.26&quot;N , 3°25'29.91&quot;E">
              <div class="hint">
                Formats : <code>12.40446, 3.38011</code> • <code>12°22'52.26&quot;N , 3°25'29.91&quot;E</code> • <code>12.41667° N, 3.51667° E</code>
              </div>
            </div>

            <div class="field">
              <label for="coords">Autres points (1 par ligne)</label>
              <textarea id="coords" name="coords" rows="12"
                        placeholder="12.41667° N, 3.51667° E
12.40000° N, 3.53333° E
12.40446° N, 3.38011° E">{{ coords or '' }}</textarea>
              <div class="hint">
                Astuce : tu peux mélanger les formats (décimal / DMS complet / degrés + N/E).
              </div>
            </div>

            <div class="row">
              <button class="btn primary" type="submit" onclick="showOverlay()">
                  <svg class="icon"><use href="#i-route"></use></svg>
                  Calculer l’itinéraire
                </button>
                <button class="btn" type="button" onclick="clearForm()">
                  <svg class="icon"><use href="#i-trash"></use></svg>
                  Effacer
                </button>
                <button class="btn" type="button" onclick="resetOps()">
                  <svg class="icon"><use href="#i-reset"></use></svg>
                  Reset Ops
                </button>
            </div>
          </form>
        </div>
      </div>

      <!-- RIGHT: Results -->
      <div class="card">
        <div class="card-h">
          <h2>Résultats</h2>
          <div class="stats">
            {% if route_rows %}
            <span class="chip">
                  <svg class="icon"><use href="#i-pin"></use></svg>
                  Points <b>{{ route_rows|length }}</b>
                </span>
                <span class="chip">
                  <svg class="icon"><use href="#i-ruler"></use></svg>
                  Total <b>{{ total_distance|round(2) }} km</b>
                </span>              
            {% else %}
              <span class="chip">Aucun résultat pour l’instant</span>
            {% endif %}
          </div>
        </div>

        {% if route_rows %}
          <div class="card-b" style="padding-bottom:12px;">
            <div class="row" style="justify-content:space-between;">
              <div class="hint" style="margin:0;">
                Marqueurs numérotés + flèches = sens de vol.
              </div>

              <form method="post" action="/download_kml" id="kmlForm" style="margin:0;">
                <input type="hidden" name="start_point" value="{{ start_point }}">
                <textarea name="coords" style="display:none;">{{ coords }}</textarea>
                <button class="btn success" type="submit" onclick="showOverlay()">
                    <svg class="icon"><use href="#i-download"></use></svg>
                    Télécharger KML
                  </button>
              </form>
            </div>
          </div>

          {% if duplicates and duplicates|length > 0 %}
  <div class="notice warn">
    <div>
      <div class="title">
        Doublons détectés <span class="badge-mini">{{ duplicates|length }}</span>
      </div>
      <div class="text">
        Certains points avaient exactement les mêmes coordonnées. Ils ont été supprimés pour éviter des segments à 0 km.
      </div>
    </div>
  </div>

  <details class="notice-details">
    <summary>
      Voir le détail des doublons supprimés
      <span class="badge-mini">Afficher</span>
    </summary>
    <div class="content">
      <ul class="dupe-list">
        {% for d in duplicates %}
          <li>
            <b>{{ d.dropped_name }}</b> supprimé (doublon de <b>{{ d.kept_name }}</b>)
            — <span class="muted">{{ d.lat }}, {{ d.lon }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </details>
{% endif %}


          
<br> 


          <div class="map-frame">
             <div id="map"></div>
              </div>


          <div class="legend">
            <div class="left">
              <span><span class="dot g"></span> Départ</span>
              <span><span class="dot b"></span> Étapes</span>
              <span><span class="dot r"></span> Arrivée</span>
              <span><svg class="icon"><use href="#i-route"></use></svg> Direction</span>
            </div>
            <div class="hint" style="margin:0;">Clique un marqueur pour détails.</div>
          </div>

          <div class="card-b" style="padding-top:14px;">
            <div class="table-wrap">
              <div class="scroll">
                <table>
                  <thead>
                    <tr>
                      <th>#</th>
                      <th class="name">Nom</th>
                      <th>Latitude</th>
                      <th>Longitude</th>
                      <th>Segment (km)</th>
                      <th>Cumul (km)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in route_rows %}
                      <tr>
                        <td>{{ row.step }}</td>
                        <td class="name">{{ row.name }}</td>
                        <td>{{ row.lat | round(6) }}</td>
                        <td>{{ row.lon | round(6) }}</td>
                        <td>{{ row.leg_distance | round(3) }}</td>
                        <td>{{ row.cum_distance | round(3) }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% else %}
          <div class="card-b">
            <div class="hint">
              Entre un point de départ et des points à visiter, puis clique <b>Calculer</b>.
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
  </script>

  <!-- Plugin flèches -->
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.js"></script>

  <script>
      function resetOps(){
    // Revenir à l'état initial (GET /) => enlève carte + tableau + résultats
    window.location.href = "/";
  }
    function showOverlay(){
      const el = document.getElementById('overlay');
      el.classList.add('on');
      el.setAttribute('aria-hidden', 'false');
      // sécurité : si l’utilisateur revient en arrière
      setTimeout(()=>{ el.classList.remove('on'); el.setAttribute('aria-hidden','true'); }, 12000);
    }
    function clearForm(){
      document.getElementById('start_point').value = "";
      document.getElementById('coords').value = "";
    }
    function fillExample(){
      document.getElementById('start_point').value = `12°22'52.26"N , 3°25'29.91"E`;
      document.getElementById('coords').value =
`12.40446° N, 3.38011° E
12.43338° N, 3.41639° E
12.41667° N, 3.51667° E
12.40000° N, 3.53333° E`;
    }
  </script>

  {% if route_rows %}
  <script>
    const routeData = {{ route_rows | tojson | safe }};

    function numberedMarker(number, color="blue") {
      return L.divIcon({
        className: "numbered-marker",
        html: `
          <div style="
            background:${color};
            width:28px;height:28px;border-radius:50%;
            border:2px solid rgba(255,255,255,.95);
            color:white;font-size:14px;font-weight:800;
            display:flex;align-items:center;justify-content:center;
            box-shadow:0 8px 18px rgba(0,0,0,.25);
          ">${number}</div>
        `,
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });
    }

    if (routeData.length > 0) {
      const map = L.map('map', { zoomControl: true });

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const latlngs = [];

      routeData.forEach((row, idx) => {
        const latlng = [row.lat, row.lon];
        latlngs.push(latlng);

        let color = "#5b8cff"; // étapes
        if (idx === 0) color = "#22c55e"; // départ
        if (idx === routeData.length - 1) color = "#ef4444"; // arrivée

        const popupContent = `
          <div style="font-family: system-ui; line-height:1.35">
            <div style="font-weight:800; margin-bottom:6px">${row.step}. ${row.name}</div>
            <div><b>Lat</b> ${row.lat.toFixed(6)} • <b>Lon</b> ${row.lon.toFixed(6)}</div>
            <div><b>Segment</b> ${row.leg_distance.toFixed(3)} km</div>
            <div><b>Cumul</b> ${row.cum_distance.toFixed(3)} km</div>
          </div>
        `;

        L.marker(latlng, { icon: numberedMarker(row.step, color) })
          .addTo(map)
          .bindPopup(popupContent);
      });

      const polyline = L.polyline(latlngs, { weight: 4 }).addTo(map);
      


      // Flèches de direction
      if (L.polylineDecorator) {
        L.polylineDecorator(polyline, {
          patterns: [{
            offset: '5%',
            repeat: '10%',
            symbol: L.Symbol.arrowHead({
              pixelSize: 10,
              polygon: false,
              pathOptions: { stroke: true }
            })
          }]
        }).addTo(map);
      }

      map.fitBounds(polyline.getBounds(), { padding: [20, 20] });
    } 

    // Flèches de direction (PolylineDecorator)
if (typeof L !== "undefined" && L.polylineDecorator) {
  const decorator = L.polylineDecorator(polyline, {
    patterns: [
      {
        offset: 25,
        repeat: 80,
        symbol: L.Symbol.arrowHead({
          pixelSize: 14,
          polygon: true,
          pathOptions: {
            stroke: true,
            weight: 2,
            opacity: 0.9,
            fillOpacity: 0.9
          }
        })
      }
    ]
  });
  decorator.addTo(map);
} else {
  console.warn("PolylineDecorator non chargé (flèches désactivées).");
}

  </script>
  {% endif %}
  

 


</body>
<footer class="container">
  <div class="footer">
    <div class="left">
      <span class="pill">PS06 Drone Navigation Toolkit </span>
      <span>© <span id="year"></span> • Drone Ops Toolkit By Faysal Abdoulkadri Mossi </span>
    </div>

    <div class="right">
      <span class="pill"> <a class="btn ghost" href="/guide">Guide</a></span>
      <span class="pill">TSP: NN + 2-opt</span>
      <span class="pill">Export: KML</span>
      <span class="pill">Distance: Haversine</span>
    </div>
  </div>
</footer>

<script>
  document.getElementById("year").textContent = new Date().getFullYear();
</script>

</html>
